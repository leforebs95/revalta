# Single shared network for all services
volumes:
  authdb_vol:
  filedb_vol:
  upload_vol:
  ocrdb_vol:
  pages_vol:

networks:
  app-network:
    driver: bridge
  auth-network:
    external: true
    name: authentication_auth-network
  file-network:
    external: true
    name: file-service_file-network
  ocr-network:
    external: true
    name: ocr-service_ocr-network
      

services:

  redis:
    image: redis:7
    ports:
      - "6379:6379"
    networks:
      - app-network
  
  react-server:
    volumes:
      - ./react/src:/usr/src/react/src
      - ./react/public:/usr/src/react/public
      - ./react/vite.config.js:/usr/src/react/vite.config.js
      - ./react/tailwind.config.js:/usr/src/react/tailwind.config.js
      - ./react/postcss.config.js:/usr/src/react/postcss.config.js
      - ./react/index.html:/usr/src/react/index.html
    networks:
      - app-network
    build: ./react
    environment:
      - PROD=false
      - HOST=0.0.0.0
      - PORT=8080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  auth-api:
    extends:
      file: ./python/authentication/docker-compose.yaml
      service: auth-api
    networks:
      - app-network
      - auth-network
    depends_on:
      - local-auth-db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/auth/version"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
  
  local-auth-db:
    extends:
      file: ./python/authentication/docker-compose.yaml
      service: local-auth-db
    networks:
      - auth-network
    volumes:
      - authdb_vol:/var/lib/mysql

  file-api:
    extends:
      file: ./python/file-service/docker-compose.yaml
      service: file-api
    networks:
      - app-network
      - file-network
    volumes:
      - upload_vol:/usr/src/file-service/uploads
    depends_on:
      - redis
      - local-file-db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/api/files/version"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    
  local-file-db:
    extends:
      file: ./python/file-service/docker-compose.yaml
      service: local-file-db
    networks:
      - file-network
    volumes:
      - filedb_vol:/var/lib/mysql

  ocr-api:
    extends:
      file: ./python/ocr/docker-compose.yaml
      service: ocr-api
    networks:
      - app-network
      - ocr-network
    volumes:
      - pages_vol:/usr/src/ocr-service/pages
    depends_on:
      - local-ocr-db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/api/ocr/version"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  local-ocr-db:
    extends:
      file: ./python/ocr/docker-compose.yaml
      service: local-ocr-db
    networks:
      - ocr-network
    volumes:
      - ocrdb_vol:/var/lib/mysql

  nginx:
    build: ./nginx
    environment:
      - AUTHENTICATION_SERVICE_HOST=auth-api
      - FILE_SERVICE_HOST=file-api
      - OCR_SERVICE_HOST=ocr-api
      - REACT_SERVICE_HOST=react-server
    ports:
      - 80:80
    networks:
      - app-network
    depends_on:
      auth-api:
        condition: service_healthy
      react-server:
        condition: service_healthy